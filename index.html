<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>The Pen Socialist Republic</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>

  <h1>ðŸš© The Pen Socialist Republic</h1>
  <p>Log in below to enter the People's Chatroom.</p>
  <button onclick="login()">Login with Google</button>

  <div id="security-question" style="display:none;">
    <h2>Security Question</h2>
    <p>What's the first letter of the legal name of the communist pen founder?</p>
    <input type="text" id="security-answer" placeholder="Enter your answer" />
    <button onclick="checkAnswer()">Submit Answer</button>
  </div>

  <div id="pen-name-section" style="display:none;">
    <h2>Enter your Pen Name</h2>
    <input type="text" id="pen-name" placeholder="Enter your pen name" />
    <button onclick="submitPenName()">Submit Pen Name</button>
  </div>

  <!-- Home Section with Navigation -->
  <div id="home-section">
    <nav>
      <button onclick="showSection('news')">News</button>
      <button onclick="showSection('members')">Members</button>
      <button onclick="showSection('constitution')">Constitution</button>
    </nav>
  </div>

  <!-- News Section -->
  <div id="news-section" style="display:none;">
    <h2>Latest News</h2>
    <div id="news-list">Loading news...</div>

    <!-- News Creation Form (Visible only for Aahil Jawad) -->
    <div id="news-form-section" style="display:none;">
      <h3>Create News</h3>
      <input type="text" id="news-heading" placeholder="Enter News Heading" />
      <input type="text" id="news-subheading" placeholder="Enter News Subheading" />
      <textarea id="news-text" placeholder="Enter News Text" rows="4"></textarea>
      <button onclick="submitNews()">Submit News</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDocs, collection, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAgorBeG4rQd0Uq3lglKAHCzEb4D7yhcF4",
      authDomain: "pen-socialist-republic.firebaseapp.com",
      projectId: "pen-socialist-republic",
      storageBucket: "pen-socialist-republic.firebasestorage.app",
      messagingSenderId: "750292729446",
      appId: "1:750292729446:web:03b1ca4355c4b0b16737a7",
      measurementId: "G-3QMLT1900F"
    };

    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();
    const db = getFirestore(app);

    let isAdmin = false; // This will be set to true if the logged-in user is Aahil Jawad

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        alert("Please log in.");
        return;
      }

      const penName = localStorage.getItem("userPenName");
      if (!penName) {
        alert("Please enter your pen name.");
        return;
      }

      // Check if the logged-in user is Aahil Jawad
      isAdmin = user.displayName === "Aahil Jawad";

      if (isAdmin) {
        document.getElementById("news-form-section").style.display = "block";
      }

      // Fetch and display news
      const newsList = document.getElementById("news-list");
      const newsSnapshot = await getDocs(collection(db, "news"));
      newsList.innerHTML = ""; // Clear loading text

      if (newsSnapshot.empty) {
        newsList.innerHTML = "No news available.";
        return;
      }

      newsSnapshot.forEach((docSnap) => {
        const data = docSnap.data();
        const div = document.createElement("div");
        div.innerHTML = `
          <h3>${data.heading}</h3>
          <h4>${data.subheading}</h4>
          <p>${data.text}</p>
          <hr />
        `;
        newsList.appendChild(div);
      });
    });

    // Login function
    window.login = function () {
      signInWithPopup(auth, provider)
        .then((result) => {
          const user = result.user;
          alert("Welcome, " + user.displayName + "! âœŠ");

          // Show the security question after login
          document.getElementById("security-question").style.display = "block";
        })
        .catch((error) => {
          alert("Login failed: " + error.message);
        });
    };

    // Submit news
    window.submitNews = async function () {
      const heading = document.getElementById("news-heading").value.trim();
      const subheading = document.getElementById("news-subheading").value.trim();
      const text = document.getElementById("news-text").value.trim();

      if (!heading || !subheading || !text) {
        alert("Please fill in all fields.");
        return;
      }

      // Save the news to Firestore
      await addDoc(collection(db, "news"), {
        heading: heading,
        subheading: subheading,
        text: text,
        createdAt: new Date(),
      });

      alert("News submitted successfully.");
      location.reload(); // Reload the page to show the new news
    };

    // Function to show the correct section based on button clicked
    window.showSection = function (section) {
      const sections = ["news", "members", "constitution"];
      sections.forEach((sec) => {
        document.getElementById(`${sec}-section`).style.display = "none";
      });
      document.getElementById(`${section}-section`).style.display = "block";
    };
  </script>

</body>
</html>
